---
#################################
# MOUNT SSD FOR S3 STORAGE      #
#################################

- name: Find block devices
  command: lsblk -b -o NAME,TYPE,SIZE,FSTYPE,MOUNTPOINT --json
  register: lsblk_output
  changed_when: false

- name: Parse block devices to find largest non-SD card disk
  set_fact:
    target_disk: "{{ (lsblk_output.stdout | from_json).blockdevices 
                     | selectattr('type', 'equalto', 'disk')
                     | rejectattr('name', 'match', '^mmcblk.*')
                     | rejectattr('name', 'match', '^zram.*')
                     | rejectattr('name', 'match', '^loop.*')
                     | sort(attribute='size', reverse=True) 
                     | first | default({}) }}"

- name: Display target disk info
  debug:
    msg: "Target disk: {{ target_disk.name | default('none') }} ({{ (target_disk.size | default(0) | int / 1073741824) | round(1) }} GB)"

- name: Fail if no suitable disk found
  fail:
    msg: "No suitable disk found for SSD storage. Please connect an SSD via USB."
  when: target_disk.name is not defined or target_disk.name == ''

- name: Check if target partition exists
  stat:
    path: "/dev/{{ target_disk.name }}1"
  register: partition_exists

- name: Check if partition has filesystem
  shell: "lsblk -no FSTYPE /dev/{{ target_disk.name }}1 2>/dev/null || true"
  register: partition_fstype
  changed_when: false
  when: partition_exists.stat.exists

- name: Create GPT partition table and single partition if needed
  shell: |
    parted -s /dev/{{ target_disk.name }} mklabel gpt
    parted -s /dev/{{ target_disk.name }} mkpart primary ext4 0% 100%
  when: not partition_exists.stat.exists

- name: Wait for partition to be recognized
  wait_for:
    path: "/dev/{{ target_disk.name }}1"
    state: present
    timeout: 10
  when: not partition_exists.stat.exists

- name: Format the partition as ext4 if needed
  filesystem:
    fstype: ext4
    dev: "/dev/{{ target_disk.name }}1"
  when: not partition_exists.stat.exists or (partition_exists.stat.exists and partition_fstype.stdout == '')

- name: Ensure SSD mount directory exists
  file:
    path: /mnt/ssd
    state: directory
    mode: '0755'

- name: Create a symlink for the device as /dev/ssd
  file:
    src: "/dev/{{ target_disk.name }}1"
    dest: /dev/ssd
    state: link
    force: yes

- name: Mount the SSD at /mnt/ssd
  mount:
    path: /mnt/ssd
    src: "/dev/{{ target_disk.name }}1"
    fstype: ext4
    opts: defaults,noatime
    state: mounted

- name: Persist mount in /etc/fstab using UUID
  shell: |
    UUID=$(blkid -s UUID -o value /dev/{{ target_disk.name }}1)
    grep -q "$UUID" /etc/fstab || echo "UUID=$UUID  /mnt/ssd  ext4  defaults,noatime  0 2" >> /etc/fstab

- name: Create MinIO data directory
  file:
    path: /mnt/ssd/minio-data
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Set permissions for MinIO data directory
  file:
    path: /mnt/ssd/minio-data
    state: directory
    mode: '0777'
    recurse: yes

- name: Display final storage info
  command: "df -h /mnt/ssd"
  register: df_output
  changed_when: false

- name: Show storage result
  debug:
    msg: "{{ df_output.stdout_lines }}"
