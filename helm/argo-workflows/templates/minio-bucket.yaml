{{- if and .Values.minio.enabled .Values.minio.buckets }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "argo-workflows.fullname" . }}-minio-bucket-creator
  namespace: {{ .Values.metadata.namespace }}
  labels:
    {{- include "argo-workflows.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: minio-bucket-creator
        image: minio/mc:latest
        command:
        - /bin/sh
        - -c
        - |
          # Wait for MinIO to be ready
          until mc alias set minio http://master:{{ .Values.minio.ports.nodeApi }} $MINIO_ACCESS_KEY $MINIO_SECRET_KEY; do
            echo "Waiting for MinIO to be ready..."
            sleep 5
          done
          
          # Create buckets if they don't exist
          {{- range .Values.minio.buckets }}
          if ! mc ls minio/{{ . }} > /dev/null 2>&1; then
            echo "Creating {{ . }} bucket..."
            mc mb minio/{{ . }}
            echo "Bucket {{ . }} created successfully"
          else
            echo "Bucket {{ . }} already exists"
          fi
          {{- end }}
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-creds
              key: accesskey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-creds
              key: secretkey
      nodeSelector:
        kubernetes.io/hostname: master
{{- end }}
